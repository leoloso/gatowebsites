---
title: Send an email to subscribers notifying of a new post
description: "Integrate this query with automation to notify users when there's a new post on the site"
order: 0
---

This query sends an email to all the users who have subscribed to an email list, notifying of the creation of a new post on the site.

The subscribed users are those with meta `email_list` with value `new_posts`. To retrieve all the users, comment out the filter in the `users` field:

```graphql
query GetPostAndExportData($postId: ID!) {
  post(by: { id: $postId }, status: any) {
    content @export(as: "postContent")
    title @export(as: "postTitle")
    url @export(as: "postURL")
  }
}

 
query GetEmailData
  @depends(on: "GetPostAndExportData")
{
  emailMessageTemplate: _strConvertMarkdownToHTML(
    text: """
 
There is a [new post on the site]({$postURL}):
 
**{$postTitle}**:
 
{$postContent}
 
    """
  )
  emailMessage: _strReplaceMultiple(
    search: ["{$postTitle}", "{$postContent}", "{$postURL}"],
    replaceWith: [$postTitle, $postContent, $postURL],
    in: $__emailMessageTemplate
  )
    @export(as: "emailMessage")
 
  emailSubject: _sprintf(
    string: "New post: \"%s\"",
    values: [$postTitle]
  )
    @export(as: "emailSubject")
}
 
mutation SendEmailToUsersAboutNewPost
  @depends(on: "GetEmailData")
{
  users(
    filter: {
      metaQuery: {
        key: "email_list",
        compareBy: {
          arrayValue: {
            value: "new_posts",
            operator: IN
          }
        }
      }
    }
  ) {
    displayName
    email
    _sendEmail(
      input: {
        to: $__email
        subject: $emailSubject
        messageAs: {
          html: $emailMessage
        }
      }
    ) {
      status
      errors {
        __typename
        ...on ErrorPayload {
          message
        }
      }
    }
  }
}
```
