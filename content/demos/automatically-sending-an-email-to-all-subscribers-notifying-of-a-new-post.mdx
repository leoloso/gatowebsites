---
title: "Automatically sending an email to all subscribers notifying of a new post"
publishedAt: '2024-06-03'
image: '/images/thumbnails/demos/gatographql-email-wordpress.png'
leading: Gato GraphQL automation demo
description: 'Whenever creating a new post on the WordPress site, automatically send a notification email to all subscriber users.'
seoDescription: 'Whenever creating a new post on the WordPress site, automatically send a notification email to all subscriber users, via Gato GraphQL.'
author: 'Leonardo Losoviz'
authorImg: '/images/leo-avatar.jpg'
tags:
  - automation
  - email
  - notification
targetImages:
  - /images/logos/email.svg
---

We can use Gato GraphQL to automatically send a notification email to all users subscribed to an email list, whenever a new post is created on the site:

<div className="aspect-video lg:-ml-32 lg:-mr-32">
  <iframe
    className="w-full h-full"
    src="https://www.youtube.com/embed/EOwZyw71TyA"
    title="Automatically sending an email to all subscribers notifying of a new post"
    width="768"
    height="432"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    allowFullScreen
  >
  </iframe>
</div>

In the demo video, website users are subscribed to email lists. This is done by storing user meta `email_list` (which is an array of list names). Users that need to be notified that there is a new post on the site are those with meta value `new_posts`.

We [create a persisted query](/guides/use/creating-a-persisted-query) called **Send an email to subscribers notifying of a new post**, select the **Nested Mutations** Schema Configuration, and provide the [following GraphQL query](/library/send-email-to-subscribers-notifying-of-a-new-post):

```graphql
query GetPostAndExportData($postId: ID!) {
  post(by: { id: $postId }, status: any) {
    content @export(as: "postContent")
    title @export(as: "postTitle")
    url @export(as: "postURL")
  }
}

 
query GetEmailData
  @depends(on: "GetPostAndExportData")
{ 
  siteName: optionValue(name: "blogname")
    @export(as: "siteName")

  emailSubject: _sprintf(
    string: "There is a new post: \"%s\"",
    values: [$postTitle]
  )
    @export(as: "emailSubject")
}
 
mutation SendEmailToUsersAboutNewPost
  @depends(on: "GetEmailData")
{
  users(
    # Users subscribed to the list. Comment out this filter to retrieve all the users
    filter: {
      metaQuery: {
        key: "email_list",
        compareBy: {
          arrayValue: {
            value: "new_posts",
            operator: IN
          }
        }
      }
    }
  ) {
    displayName
    email

    emailMessageTemplate: _strConvertMarkdownToHTML(
      text: """

  Hi {$userDisplayName},
  
  There is a new post on the **{$siteName}** website:
  
  [**{$postTitle}**]({$postURL})
  
  {$postContent}
  
      """
    )
      @remove
    emailMessage: _strReplaceMultiple(
      search: ["{$userDisplayName}", "{$siteName}", "{$postTitle}", "{$postContent}", "{$postURL}"],
      replaceWith: [$__displayName, $siteName, $postTitle, $postContent, $postURL],
      in: $__emailMessageTemplate
    )
      @remove

    _sendEmail(
      input: {
        to: $__email
        subject: $emailSubject
        messageAs: {
          html: $__emailMessage
        }
      }
    ) {
      status
      errors {
        __typename
        ...on ErrorPayload {
          message
        }
      }
    }
  }
}
```

We test it by passing GraphQL variable `$postId` with value `1` in the JSON dictionary, and executing the GraphQL query. When checking in Mailpit (which intercepts all emails), we verify that an email was indeed sent to all 3 users who have subscribed to the email list.

For instance, user "Blogger Davenport" received the following email:

<Image
  src="/images/notification-email-about-new-post-sent-to-user.png"
  width="1024"
  height="600"
  alt="Notification email about new post sent to user"
  caption="Notification email about new post sent to user"
/>

Finally we automate the process, so that whenever there is a new post on the site, the notification email is automatically sent.

For that, we [create an automation rule](/guides/manage/automating-tasks) called **When a post is published, send an email to subscribers**, selecting the previously-created persisted query **Send an email to subscribers notifying of a new post** as the action, and providing the following information as the trigger:

- Hook name: `publish_post`
- Dynamic GraphQL variables:

```json
{
  "postId": 1
}
```

Finally we create a new post, and publish it. As a result, a notification email is sent to all subscribers.
